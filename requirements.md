# Macç”¨ MP4éŸ³å£°å·®ã—æ›¿ãˆã‚¢ãƒ—ãƒª ä»•æ§˜æ›¸

## æ¦‚è¦

ã€Œæ­Œã£ã¦ã¿ãŸã€å‹•ç”»åˆ¶ä½œè€…å‘ã‘ã®ã€MP4ãƒ•ã‚¡ã‚¤ãƒ«ã®éŸ³å£°ã‚’ç„¡åŠ£åŒ–ã§å·®ã—æ›¿ãˆã‚‹Macã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚å‹•ç”»ã®ç”»è³ªã‚’ç¶­æŒã—ãŸã¾ã¾ã€æ—¢å­˜ã®éŸ³å£°ã‚’æ–°ã—ã„WAVéŸ³æºã«ç½®ãæ›ãˆã‚‹ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°åŒæœŸæ©Ÿèƒ½ã«ã‚ˆã‚Šã€å‹•ç”»å†…ã®éŸ³å£°ã¨æ–°ã—ã„éŸ³æºã®ãšã‚Œã‚’è‡ªå‹•ã¾ãŸã¯æ‰‹å‹•ã§èª¿æ•´å¯èƒ½ã€‚

---

## 1. é–‹ç™ºæ–¹é‡

### 1.1 æŠ€è¡“é¸å®š

| é …ç›® | æŽ¡ç”¨æŠ€è¡“ | ç†ç”± |
|------|----------|------|
| **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | SwiftUI + AppKit | macOS 11ä»¥é™ã®æ¨™æº–UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚ç›´æ„Ÿçš„ãªUIæ§‹ç¯‰ãŒå¯èƒ½ |
| **æ˜ åƒ/éŸ³å£°å‡¦ç†** | FFmpeg (libavformat/libavcodec) | ç„¡åŠ£åŒ–ã§ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚³ãƒ”ãƒ¼ãŒå¯èƒ½ã€‚æ¥­ç•Œæ¨™æº– |
| **éŸ³å£°åŒæœŸåˆ†æž** | Accelerate Framework + vDSP | macOSæ¨™æº–ã®é«˜é€Ÿä¿¡å·å‡¦ç†ã€‚ç›¸äº’ç›¸é–¢ã«ã‚ˆã‚‹åŒæœŸæ¤œå‡º |
| **æ³¢å½¢è¡¨ç¤º** | AVFoundation + Core Graphics | ãƒã‚¤ãƒ†ã‚£ãƒ–ãªæ³¢å½¢æç”» |
| **é…å¸ƒå½¢å¼** | .app (å…¬è¨¼æ¸ˆã¿) ã¾ãŸã¯ Homebrew | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ã„ã‚„ã™ã„å½¢å¼ |

### 1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SwiftUI View Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠžâ”‚  â”‚  æ³¢å½¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”‚  â”‚  ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ViewModel Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProjectViewModel â”‚  â”‚  SyncAnalyzerViewModel     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FFmpegServiceâ”‚  â”‚ AudioAnalyzerâ”‚  â”‚ WaveformGen  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ©Ÿèƒ½è¦ä»¶

### 2.1 å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«

| é …ç›® | ä»•æ§˜ |
|------|------|
| å‹•ç”»å½¢å¼ | MP4 (H.264/H.265ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯) |
| éŸ³å£°å½¢å¼ | WAV (PCM 16bit/24bit/32bit, 44.1kHz/48kHz/96kHz) |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºä¸Šé™ | åˆ¶é™ãªã—ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ï¼‰ |

### 2.2 å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«

| é …ç›® | ä»•æ§˜ |
|------|------|
| ã‚³ãƒ³ãƒ†ãƒŠå½¢å¼ | MP4 |
| æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒ  | å…¥åŠ›ã‹ã‚‰ã®ç„¡åŠ£åŒ–ã‚³ãƒ”ãƒ¼ (`-c:v copy`) |
| éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ  | ç„¡åŠ£åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¾Œè¿°ï¼‰ |

### 2.3 éŸ³å£°ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰è¨­å®š

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥ä¸‹ã‹ã‚‰é¸æŠžå¯èƒ½ï¼š

1. **FLACï¼ˆæŽ¨å¥¨ï¼‰** - å¯é€†åœ§ç¸®ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›
2. **ALAC** - Apple Losslessã€Appleã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®è¦ªå’Œæ€§
3. **PCM** - éžåœ§ç¸®ã€æœ€å¤§äº’æ›æ€§

```bash
# FFmpegã‚³ãƒžãƒ³ãƒ‰ä¾‹ï¼ˆFLACä½¿ç”¨æ™‚ï¼‰
ffmpeg -i input.mp4 -i new_audio.wav \
  -map 0:v -map 1:a \
  -c:v copy -c:a flac \
  -shortest output.mp4
```

### 2.4 ã‚¿ã‚¤ãƒŸãƒ³ã‚°åŒæœŸæ©Ÿèƒ½

#### 2.4.1 è‡ªå‹•åŒæœŸï¼ˆç›¸äº’ç›¸é–¢æ³•ï¼‰

1. å‹•ç”»ã®éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«æŠ½å‡º
2. æ–°ã—ã„WAVéŸ³æºã¨ã®ç›¸äº’ç›¸é–¢ã‚’è¨ˆç®—
3. æœ€å¤§ç›¸é–¢ç‚¹ã‹ã‚‰ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆãšã‚Œæ™‚é–“ï¼‰ã‚’æ¤œå‡º
4. æ¤œå‡ºç²¾åº¦ï¼šã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆä¾å­˜ï¼ˆ48kHzã§ç´„0.02msç²¾åº¦ï¼‰

```
ç›¸äº’ç›¸é–¢ R(Ï„) = Î£ x(t) Ã— y(t + Ï„)
```

#### 2.4.2 æ‰‹å‹•åŒæœŸ

- 2ã¤ã®æ³¢å½¢ã‚’ä¸Šä¸‹ã«ä¸¦ã¹ã¦è¡¨ç¤º
- ãƒ‰ãƒ©ãƒƒã‚°ã§æ–°éŸ³å£°ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’èª¿æ•´
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿã§ç¢ºèªå¯èƒ½

#### 2.4.3 ã‚ªãƒ•ã‚»ãƒƒãƒˆé©ç”¨

```bash
# æ­£ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆæ–°éŸ³å£°ã‚’é…ã‚‰ã›ã‚‹ï¼‰
ffmpeg -i input.mp4 -itsoffset 0.5 -i new_audio.wav ...

# è² ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆæ–°éŸ³å£°ã®å…ˆé ­ã‚’ã‚«ãƒƒãƒˆï¼‰
ffmpeg -ss 0.5 -i new_audio.wav ...
```

---

## 3. UIè¨­è¨ˆ

### 3.1 ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŽ¬ éŸ³å£°å·®ã—æ›¿ãˆã‚¢ãƒ—ãƒª                              [â”€][â–¡][Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«         â”‚  â”‚      éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—   â”‚   â”‚  â”‚  â”‚ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   ã¾ãŸã¯é¸æŠž       â”‚   â”‚  â”‚  â”‚   ã¾ãŸã¯é¸æŠž       â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  ðŸ“ video.mp4           â”‚  â”‚  ðŸ“ vocal.wav            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ³¢å½¢è¡¨ç¤ºã‚¨ãƒªã‚¢                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…ƒã®éŸ³å£°         â”‚ â”‚
â”‚  â”‚  â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ æ–°ã—ã„éŸ³å£°       â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  ã‚ªãƒ•ã‚»ãƒƒãƒˆ: [-0.35 ç§’]  [â—€][â–¶] å¾®èª¿æ•´   [ðŸ”„ è‡ªå‹•æ¤œå‡º]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å‡ºåŠ›è¨­å®š                                                  â”‚ â”‚
â”‚  â”‚  éŸ³å£°ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯: [FLAC â–¼]   ä¿å­˜å…ˆ: [~/Desktop â–¼]         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚            [â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼]        [ðŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ]            â”‚
â”‚                                                                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100%            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ“ä½œãƒ•ãƒ­ãƒ¼

```
1. å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—
        â†“
2. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—
        â†“
3. [è‡ªå‹•æ¤œå‡º] ã¾ãŸã¯ æ‰‹å‹•ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´
        â†“
4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        â†“
5. å‡ºåŠ›è¨­å®šã‚’é¸æŠž
        â†“
6. [ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ] â†’ å®Œäº†
```

---

## 4. æŠ€è¡“è©³ç´°

### 4.1 FFmpegçµ±åˆæ–¹æ³•

#### æ–¹æ³•A: ãƒãƒ³ãƒ‰ãƒ«æ¸ˆã¿ãƒã‚¤ãƒŠãƒªï¼ˆæŽ¨å¥¨ï¼‰

```swift
// FFmpegãƒã‚¤ãƒŠãƒªã‚’ã‚¢ãƒ—ãƒªãƒãƒ³ãƒ‰ãƒ«ã«åŒæ¢±
let ffmpegPath = Bundle.main.path(forResource: "ffmpeg", ofType: nil)

func executeFFmpeg(arguments: [String]) async throws {
    let process = Process()
    process.executableURL = URL(fileURLWithPath: ffmpegPath!)
    process.arguments = arguments
    
    let pipe = Pipe()
    process.standardError = pipe
    
    try process.run()
    process.waitUntilExit()
    
    if process.terminationStatus != 0 {
        let errorData = pipe.fileHandleForReading.readDataToEndOfFile()
        throw FFmpegError.executionFailed(String(data: errorData, encoding: .utf8) ?? "")
    }
}
```

#### æ–¹æ³•B: Homebrewä¾å­˜

```swift
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒHomebrewã§FFmpegã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã¨ä»®å®š
let ffmpegPath = "/opt/homebrew/bin/ffmpeg"
```

### 4.2 è‡ªå‹•åŒæœŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```swift
import Accelerate

func detectOffset(original: [Float], replacement: [Float]) -> TimeInterval {
    // ç›¸äº’ç›¸é–¢ã®è¨ˆç®—
    let correlationLength = original.count + replacement.count - 1
    var correlation = [Float](repeating: 0, count: correlationLength)
    
    vDSP_conv(original, 1, 
              replacement.reversed(), 1, 
              &correlation, 1, 
              vDSP_Length(correlationLength), 
              vDSP_Length(replacement.count))
    
    // æœ€å¤§ç›¸é–¢ç‚¹ã‚’æ¤œå‡º
    var maxValue: Float = 0
    var maxIndex: vDSP_Length = 0
    vDSP_maxvi(correlation, 1, &maxValue, &maxIndex, vDSP_Length(correlationLength))
    
    // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ã‚µãƒ³ãƒ—ãƒ«æ•°ã‹ã‚‰ç§’ã«å¤‰æ›
    let offsetSamples = Int(maxIndex) - replacement.count + 1
    let offsetSeconds = Double(offsetSamples) / sampleRate
    
    return offsetSeconds
}
```

### 4.3 ç„¡åŠ£åŒ–å‡¦ç†ã®ç¢ºä¿

```swift
struct ExportSettings {
    enum AudioCodec: String {
        case flac = "flac"           // å¯é€†åœ§ç¸®
        case alac = "alac"           // Apple Lossless
        case pcm_s16le = "pcm_s16le" // éžåœ§ç¸®16bit
        case pcm_s24le = "pcm_s24le" // éžåœ§ç¸®24bit
    }
    
    var videoCodec: String = "copy"  // å¸¸ã«ç„¡åŠ£åŒ–
    var audioCodec: AudioCodec = .flac
    var offsetSeconds: Double = 0.0
}

func buildFFmpegArguments(input: URL, audio: URL, output: URL, settings: ExportSettings) -> [String] {
    var args = ["-y"]  // ä¸Šæ›¸ãè¨±å¯
    
    // ã‚ªãƒ•ã‚»ãƒƒãƒˆå‡¦ç†
    if settings.offsetSeconds > 0 {
        args += ["-itsoffset", String(settings.offsetSeconds)]
    }
    
    args += ["-i", input.path]
    
    if settings.offsetSeconds < 0 {
        args += ["-ss", String(-settings.offsetSeconds)]
    }
    
    args += ["-i", audio.path]
    
    // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒžãƒƒãƒ”ãƒ³ã‚°
    args += [
        "-map", "0:v",     // å‹•ç”»ã¯å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰
        "-map", "1:a",     // éŸ³å£°ã¯æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰
        "-c:v", "copy",    // å‹•ç”»ã¯ç„¡åŠ£åŒ–ã‚³ãƒ”ãƒ¼
        "-c:a", settings.audioCodec.rawValue,
        "-shortest",       // çŸ­ã„æ–¹ã«åˆã‚ã›ã‚‹
        output.path
    ]
    
    return args
}
```

---

## 5. åˆ¶ç´„äº‹é …ãƒ»æ³¨æ„ç‚¹

### 5.1 æŠ€è¡“çš„åˆ¶ç´„

| é …ç›® | å†…å®¹ |
|------|------|
| ã‚³ãƒ³ãƒ†ãƒŠäº’æ›æ€§ | FLAC in MP4ã¯ä¸€éƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§éžå¯¾å¿œã®å¯èƒ½æ€§ã‚ã‚Š |
| é•·å°ºå‹•ç”» | ç›¸äº’ç›¸é–¢ã¯è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆ10åˆ†è¶…ã¯éƒ¨åˆ†åˆ†æžæŽ¨å¥¨ï¼‰ |
| ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ | å‹•ç”»éŸ³å£°ã¨æ–°éŸ³å£°ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆãŒç•°ãªã‚‹å ´åˆã€ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å¿…è¦ |

### 5.2 å¯¾å¿œç­–

```swift
// ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆä¸ä¸€è‡´æ™‚ã®è‡ªå‹•ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
if originalSampleRate != replacementSampleRate {
    // éŸ³å£°å´ã‚’ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆå“è³ªå„ªå…ˆï¼‰
    args += ["-af", "aresample=\(originalSampleRate):resampler=soxr"]
}
```

### 5.3 macOSè¦ä»¶

- **æœ€å°å¯¾å¿œ**: macOS 11.0 (Big Sur)
- **æŽ¨å¥¨**: macOS 13.0 (Ventura) ä»¥é™
- **å¿…è¦æ¨©é™**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¯¾å¿œï¼‰

---

## 6. é–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—

### Phase 1: MVPï¼ˆ2-3é€±é–“ï¼‰
- [x] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆ
- [ ] åŸºæœ¬UIå®Ÿè£…
- [ ] FFmpegçµ±åˆ
- [ ] å›ºå®šã‚ªãƒ•ã‚»ãƒƒãƒˆã§ã®éŸ³å£°å·®ã—æ›¿ãˆ

### Phase 2: åŒæœŸæ©Ÿèƒ½ï¼ˆ2é€±é–“ï¼‰
- [ ] æ³¢å½¢è¡¨ç¤º
- [ ] æ‰‹å‹•ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´
- [ ] è‡ªå‹•åŒæœŸï¼ˆç›¸äº’ç›¸é–¢ï¼‰

### Phase 3: ä»•ä¸Šã’ï¼ˆ1-2é€±é–“ï¼‰
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- [ ] å…¬è¨¼ãƒ»é…å¸ƒæº–å‚™

---

## 7. å‚è€ƒã‚³ãƒžãƒ³ãƒ‰é›†

```bash
# åŸºæœ¬çš„ãªéŸ³å£°å·®ã—æ›¿ãˆ
ffmpeg -i video.mp4 -i audio.wav -map 0:v -map 1:a -c:v copy -c:a flac output.mp4

# éŸ³å£°ã‚’0.5ç§’é…ã‚‰ã›ã‚‹
ffmpeg -i video.mp4 -itsoffset 0.5 -i audio.wav -map 0:v -map 1:a -c:v copy -c:a flac output.mp4

# éŸ³å£°ã®å…ˆé ­0.3ç§’ã‚’ã‚«ãƒƒãƒˆ
ffmpeg -i video.mp4 -ss 0.3 -i audio.wav -map 0:v -map 1:a -c:v copy -c:a flac output.mp4

# å‹•ç”»ã‹ã‚‰éŸ³å£°ã‚’æŠ½å‡ºï¼ˆåŒæœŸåˆ†æžç”¨ï¼‰
ffmpeg -i video.mp4 -vn -c:a pcm_s16le original_audio.wav

# ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ç¢ºèª
ffprobe -v quiet -print_format json -show_streams video.mp4
```

---

## 8. ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»ä¾å­˜é–¢ä¿‚

| ä¾å­˜ | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ | ç”¨é€” |
|------|------------|------|
| FFmpeg | LGPL 2.1+ / GPL | æ˜ åƒãƒ»éŸ³å£°å‡¦ç† |
| SwiftUI | Apple | UI |
| Accelerate | Apple | ä¿¡å·å‡¦ç† |

**æ³¨æ„**: FFmpegã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹å ´åˆã€GPLãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚’å«ã‚€ã¨ã‚¢ãƒ—ãƒªå…¨ä½“ãŒGPLé©ç”¨ã¨ãªã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚LGPLãƒ“ãƒ«ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€å‹•çš„ãƒªãƒ³ã‚¯ã‚’æ¤œè¨Žã€‚

---

*æœ€çµ‚æ›´æ–°: 2025å¹´1æœˆ*
